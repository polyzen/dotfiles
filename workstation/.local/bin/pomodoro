#!/usr/bin/env bash

set -e

if [[ -n $TMUX ]]; then
  trap 'tmux set automatic-rename' EXIT
fi

INTERVALS=('Po' 'mo' 'do' 'ro')
WORKMSG='ðŸ” Focus'
WORKTIME='25m'
SHORTBREAKMSG='ðŸ§˜ Stretch'
SHORTBREAKTIME='5m'
LONGBREAKMSG='ðŸ’† Rest'
LONGBREAKTIME='15m'

BEEP=0
LOOP=0

while :; do
  case $1 in
    -b|--beep)
      BEEP=1
      ;;
    -l|--loop)
      LOOP=1
      ;;
    -?*)
      printf 'WARN: Unknown option (ignored): %s\n' "$1" >&2
      ;;
    *)
      break
  esac

  shift
done

timer() {
  if [[ -n $TMUX ]]; then
    tmux rename-window "$1"
  fi

  toastify send --id 45 "$1" "$intervalmsg"
  termdown -T "$1" "$2"

  if [[ $BEEP -eq 1 ]]; then
    beep -f 5000 -l 50 -r 2
  fi
}

pomodoro() {
  for (( i = 1; i <= ${#INTERVALS[*]}; i++ )); do
    # Highlight (in bold) intervals as they pass
    local intervalmsg="<b>${INTERVALS[*]:0:i}</b> ${INTERVALS[*]:i}"

    if (( i < ${#INTERVALS[*]} )); then
      local breakmsg="$SHORTBREAKMSG"
      local breaktime="$SHORTBREAKTIME"
    else
      local breakmsg="$LONGBREAKMSG"
      local breaktime="$LONGBREAKTIME"
    fi

    timer "$WORKMSG" "$WORKTIME"
    timer "$breakmsg" "$breaktime"
  done
}

if [[ $LOOP -eq 1 ]]; then
  while true; do
    pomodoro
  done
else
  pomodoro
fi
